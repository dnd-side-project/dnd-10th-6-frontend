import { GetServerSideProps } from 'next'
import Button from '@/components/button'
import Logo from '@/components/ui/logo'
import { useSession } from '@/provider/session-provider'
import { useRouter } from 'next/router'
import BaseLayout from '@/layout/base-layout'
import { ReactNode, useContext, useEffect, useRef, useState } from 'react'
import { useMount } from '@/hooks/use-mount'
import { useBrowserLayoutEffect } from '@/lib/client/utils'
import { ShareImageContext } from '@/components/share-image'

const Page = () => {
  const { shareImage } = useContext(ShareImageContext)
  const { signin, data } = useSession()
  const router = useRouter()
  const mounted = useMount()
  const [isPending, setIsPending] = useState(false)
  const pendingRef = useRef<NodeJS.Timeout>()

  const handleLogin = () => {
    setIsPending(true)
    signin({ provider: 'kakao' })
    pendingRef.current = setTimeout(() => {
      setIsPending(false)
    }, 15000)
  }
  useBrowserLayoutEffect(() => {
    if (data?.user) {
      if (data.user && !data.user.name) {
        router.replace('/signup', undefined, { shallow: true })
      }
    }
  }, [data, router])

  useEffect(() => {
    return () => {
      clearTimeout(pendingRef.current)
    }
  }, [])

  return !mounted ? (
    <>Loading...</>
  ) : (
    <div className="h-calc-h flex flex-col px-5 py-4">
      <button
        onClick={() =>
          shareImage({
            type: 'tesst',
            icon: (
              <svg
                width="216"
                height="224"
                viewBox="0 0 216 224"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M92.2749 1C74.9477 1.00027 69.522 47.8744 68.6666 68.7454C68.2667 75.4171 63.0213 76.4439 39.413 92.3539C20.5264 105.082 29.8328 120.923 36.8469 127.253C23.332 130.674 -2.67129 142.239 1.43449 161.126C5.54028 180.012 24.7006 183.365 33.7675 182.681C33.0832 183.708 34.5886 189.353 46.0848 203.723C57.581 218.093 77.5625 209.711 86.1162 203.723C125.121 240.265 136.241 214.843 136.925 197.565C145.308 201.157 163.202 202.081 167.719 177.036C172.235 151.99 143.939 123.832 129.227 112.883C167.719 116.646 136.925 82.6448 123.201 70.1449C107.351 55.7087 112.201 0.99969 92.2749 1Z"
                  fill="#00BC68"
                  stroke="black"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
                <path
                  d="M47.7046 125.647C34.5058 132.246 31.8713 143.314 31.7046 147.147C30.7046 155.647 35.7046 167.647 44.2046 178.647C52.7046 189.647 73.7046 187.147 78.7046 186.647C83.7046 186.147 98.7046 182.647 101.205 168.147C103.705 153.647 92.2046 137.647 88.7046 132.647C85.2046 127.647 65.7051 116.647 47.7046 125.647Z"
                  fill="#3366FF"
                  stroke="black"
                  stroke-width="2"
                />
                <path
                  d="M64.2054 143.646C84.6054 144.046 89.0387 136.48 88.7054 132.646C93.9056 137.046 98.5386 149.146 100.205 154.646C94.7051 166.146 81.7051 169.646 69.7051 171.146C64.1167 171.845 57.8777 170.917 52.7051 168.766C46.7705 166.299 42.2397 162.222 41.7054 157.146C40.9006 149.501 39.448 145.094 52.2051 143.925C55.2988 143.642 59.2283 143.549 64.2054 143.646Z"
                  fill="#FFEB34"
                />
                <path
                  d="M52.2051 143.925C55.2988 143.642 59.2283 143.549 64.2054 143.646C84.6054 144.046 89.0387 136.48 88.7054 132.646C93.9056 137.046 98.5386 149.146 100.205 154.646C94.7051 166.146 81.7051 169.646 69.7051 171.146C64.1167 171.845 57.8777 170.917 52.7051 168.766M52.2051 143.925C39.448 145.094 40.9006 149.501 41.7054 157.146C42.2397 162.222 46.7705 166.299 52.7051 168.766M52.2051 143.925C51.8717 150.246 51.5051 164.062 52.7051 168.766M81.2051 147.646L77.2051 157.146M88.7054 144.646L82.7051 162.646"
                  stroke="black"
                  stroke-width="2"
                />
                <path
                  d="M82.1985 68.1453C72.1995 65.6463 64.2013 63.6473 64.2013 72.146C63.2013 74.646 66.2012 80.646 67.2012 82.146C68.3106 83.8102 75.2016 92.1461 85.2016 90.1461C94.9706 88.1923 93.7016 81.146 94.7016 79.646C95.5016 78.446 97.7016 79.146 98.7016 79.646C99.7016 83.146 105.202 89.6461 110.202 90.1461C115.202 90.6461 123.16 88.2291 126.201 82.146C131.201 72.146 127.201 66.1465 123.201 66.1465C118.457 66.1465 113.201 66.6465 107.202 68.1461C102.933 69.213 100.368 71.4794 99.7016 73.146H94.7016C94.7016 71.4794 91.9032 70.5707 82.2016 68.1461L82.1985 68.1453Z"
                  fill="#111111"
                />
                <path
                  d="M75.2031 83.0036L85.6586 73.1465M79.5596 85.1465L90.4506 74.8608M103.52 83.4322L113.975 73.1465M107.876 85.1465L119.203 74.8608"
                  stroke="white"
                  stroke-width="2"
                />
                <path
                  d="M6.6995 152.145C1.0995 131.745 22.6995 119.645 34.1995 116.145C36.8661 115.978 42.4992 117.045 43.6992 122.645C45.1992 129.645 37.1989 132.145 35.6992 136.145C34.3573 139.724 33.0153 148.391 33.8223 150.406C33.9483 150.546 34.0741 150.685 34.1995 150.822C41.9602 159.307 48.4418 161.933 51.1992 161.145C54.6992 160.145 60.1992 161.145 55.1992 165.645C50.1992 170.145 55.1992 167.145 63.1992 171.645C69.5992 175.245 60.5326 174.478 55.1992 173.645C68.1992 176.145 67.6992 177.645 66.6992 180.145C66.1375 181.549 61.7638 181.064 57.7657 180.246C60.4171 181.113 62.9528 182.42 63.1992 184.145C63.5057 186.29 58.3534 185.833 53.9032 184.977C59.0184 186.809 58.9359 190.477 50.1992 189.645C39.6992 188.645 13.6995 177.645 6.6995 152.145Z"
                  fill="#FDFBEF"
                />
                <path
                  d="M27.6992 142.645C29.9269 145.827 32.1096 148.537 34.1995 150.822M34.1995 150.822C41.9602 159.307 48.4418 161.933 51.1992 161.145C54.6992 160.145 60.1992 161.145 55.1992 165.645C50.1992 170.145 55.1992 167.145 63.1992 171.645C69.5992 175.245 60.5326 174.478 55.1992 173.645C68.1992 176.145 67.6992 177.645 66.6992 180.145C65.8992 182.145 57.3659 180.312 53.1992 179.145C56.3659 179.645 62.7992 181.345 63.1992 184.145C63.5992 186.945 54.6992 185.312 50.1992 184.145C58.6992 185.145 60.6992 190.645 50.1992 189.645C39.6992 188.645 13.6995 177.645 6.6995 152.145C1.0995 131.745 22.6995 119.645 34.1995 116.145C36.8661 115.978 42.4992 117.045 43.6992 122.645C45.1992 129.645 37.1989 132.145 35.6992 136.145C34.1995 140.145 32.6998 150.499 34.1995 150.822Z"
                  stroke="black"
                  stroke-width="2"
                />
                <path
                  d="M146.698 125.146C155.65 128.628 168.098 141.946 175.698 131.146C183.298 120.346 182.139 113.146 181.698 110.146C180.865 104.48 180.298 93.5464 184.698 95.1464C189.098 96.7464 192.531 105.813 193.698 110.146C194.865 109.313 198.498 107.946 203.698 109.146C204.524 109.337 205.309 109.681 206.051 110.146C208.246 111.524 210.062 113.965 211.417 116.646C212.246 118.286 212.902 120.015 213.369 121.646C213.912 123.545 214.198 125.31 214.198 126.646C214.198 131.037 209.956 133.886 205.198 134.515C205.365 143.725 200.498 163.046 179.698 166.646C158.898 170.246 149.198 165.146 144.698 163.146C138.698 160.646 129.846 154.095 130.698 145.146C131.698 134.646 137.698 121.646 146.698 125.146Z"
                  fill="#FDFBEF"
                />
                <path
                  d="M193.698 110.146C192.531 105.813 189.098 96.7464 184.698 95.1464C180.298 93.5464 180.865 104.48 181.698 110.146C182.139 113.146 183.298 120.346 175.698 131.146C168.098 141.946 155.65 128.628 146.698 125.146C137.698 121.646 131.698 134.646 130.698 145.146C129.846 154.095 138.698 160.646 144.698 163.146C149.198 165.146 158.898 170.246 179.698 166.646C200.498 163.046 205.365 143.725 205.198 134.515M193.698 110.146C194.865 109.313 198.498 107.946 203.698 109.146C204.524 109.337 205.309 109.681 206.051 110.146M193.698 110.146C192.322 111.66 190.082 115.242 190.244 119.146M190.244 119.146C190.278 119.971 190.419 120.81 190.698 121.646C191.081 122.795 191.574 123.981 192.159 125.146M190.244 119.146C193.964 119.313 202.334 117.746 206.051 110.146M206.051 110.146C208.246 111.524 210.062 113.965 211.417 116.646M192.159 125.146C197.151 125.146 207.992 123.446 211.417 116.646M192.159 125.146C193.154 127.128 194.415 129.053 195.858 130.646M211.417 116.646C212.246 118.286 212.902 120.015 213.369 121.646M195.858 130.646C198 133.012 200.54 134.646 203.198 134.646C203.868 134.646 204.538 134.602 205.198 134.515M195.858 130.646C200.252 131.813 209.906 131.646 213.369 121.646M213.369 121.646C213.912 123.545 214.198 125.31 214.198 126.646C214.198 131.037 209.956 133.886 205.198 134.515"
                  stroke="black"
                  stroke-width="2"
                />
                <path
                  d="M91.2031 102.146C93.2031 102.813 97.9031 103.746 100.703 102.146C103.503 100.546 104.203 98.8132 104.203 98.1465"
                  stroke="black"
                  stroke-width="3"
                  stroke-linecap="round"
                />
              </svg>
            ),
          })
        }
      >
        GOGO
      </button>
      <section className="grow flex flex-col text-center justify-center items-center space-y-16">
        <div className="flex flex-col space-y-4">
          <div className="h-[38px]">
            <Logo />
          </div>
          <h2 className="text-subTitle1-medium">남이 써주는 나의 소개서</h2>
        </div>
        <svg
          width="189"
          height="270"
          viewBox="0 0 189 270"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M107.14 63.4301C108.377 66.0357 108.703 68.7267 108.277 70.9506C107.85 73.1753 106.693 74.86 105.013 75.6574C103.333 76.4548 101.296 76.2863 99.3023 75.2105C97.3095 74.1351 95.4312 72.1805 94.1944 69.5749C92.9576 66.9692 92.6308 64.2782 93.0575 62.0543C93.4843 59.8296 94.6416 58.1449 96.3215 57.3475C98.0015 56.5501 100.038 56.7186 102.032 57.7944C104.025 58.8699 105.903 60.8244 107.14 63.4301Z"
            fill="white"
            stroke="#111111"
            strokeWidth="2"
          />
          <ellipse
            cx="100.608"
            cy="63.6897"
            rx="6.68039"
            ry="7.79379"
            transform="rotate(-32.2559 100.608 63.6897)"
            fill="#111111"
          />
          <path
            d="M103.059 252.802C104.404 250.025 103.48 209 102.595 192.414L106.369 171.811L88.4689 177.103C88.4418 193.473 88.1434 230.032 87.1664 245.306C86.1893 260.58 86.8479 264.515 87.2993 264.573C91.9215 271.069 115.233 266.594 119.857 265.823C124.901 264.983 143.896 262.315 137.926 253.642C133.3 246.922 101.377 256.273 103.059 252.802Z"
            fill="#FFEB34"
            stroke="#111111"
            strokeWidth="2"
          />
          <path
            d="M70.7327 249.83C72.2892 247.24 74.5959 209.412 74.9342 192.772L80.2458 172.316L61.8777 175.241C60.6393 191.547 57.6347 227.932 55.5234 243.021C53.412 258.111 55.2615 259.693 55.2615 259.693C59.4229 266.771 78.3227 266.991 83.0278 266.9C88.5761 266.793 107.726 267.897 103.176 258.096C98.6249 248.295 68.7871 253.068 70.7327 249.83Z"
            fill="#FFEB34"
            stroke="#111111"
            strokeWidth="2"
          />
          <path
            d="M74.2816 26.3757C61.1868 31.8176 61.7911 67.1478 63.7302 84.1327C64.2477 89.5781 60.1355 91.0696 43.0504 106.911C29.3824 119.583 38.9046 131.22 45.3743 135.455C34.8769 139.925 15.3074 152.554 21.0081 167.309C26.7088 182.064 42.6251 182.36 49.8706 180.664C49.4467 181.58 51.3756 185.956 62.4832 196.127C73.5907 206.298 88.6918 197.001 94.8539 191.081C131.001 215.713 136.788 193.755 135.164 179.697C142.395 181.545 156.981 180.037 157.477 159.215C157.972 138.393 131.542 119.189 118.265 112.19C151.514 115.509 123.513 85.8664 109.888 74.8124C96.2622 63.7584 90.6501 19.5733 74.2816 26.3757Z"
            fill="#00BC68"
            stroke="#111111"
            strokeWidth="2"
            strokeLinejoin="round"
          />
          <path
            d="M94.9613 67.1881C95.8999 69.9154 95.9246 72.626 95.2525 74.7885C94.5803 76.9517 93.2424 78.4969 91.484 79.102C89.7256 79.7071 87.7202 79.3125 85.8591 78.0211C83.9986 76.7302 82.35 74.5784 81.4114 71.8511C80.4728 69.1237 80.4481 66.4131 81.1202 64.2506C81.7924 62.0874 83.1304 60.5422 84.8887 59.9371C86.6471 59.332 88.6526 59.7266 90.5136 61.018C92.3741 62.309 94.0228 64.4607 94.9613 67.1881Z"
            fill="white"
            stroke="#111111"
            strokeWidth="2"
          />
          <ellipse
            cx="88.4407"
            cy="66.7177"
            rx="6.68039"
            ry="7.79379"
            transform="rotate(-25.8537 88.4407 66.7177)"
            fill="#111111"
          />
          <path
            fillRule="evenodd"
            clipRule="evenodd"
            d="M111.397 81.9411C110.586 81.4908 109.563 81.7834 109.112 82.5946C108.792 83.1722 108.105 84.0779 107.178 84.7583C106.267 85.4272 105.253 85.791 104.165 85.613C103.249 85.4632 102.386 86.0841 102.236 86.9999C102.086 87.9156 102.707 88.7793 103.623 88.9291C105.867 89.2962 107.777 88.4866 109.166 87.4673C110.539 86.4594 111.53 85.1621 112.05 84.2255C112.501 83.4143 112.208 82.3915 111.397 81.9411Z"
            fill="#111111"
          />
          <path
            d="M128.678 12.6739C128.678 3.53781 130.877 1.84594 132.738 1L169.79 2.52269L186.54 13.1815L170.419 23.4807C169.633 24.1957 168.857 24.641 168.267 24.8554H138.321C132.231 24.3478 128.678 23.8403 128.678 12.6739Z"
            fill="#FAA71E"
          />
          <path
            d="M168.267 24.8554H138.321C132.231 24.3478 128.678 23.8403 128.678 12.6739C128.678 3.53781 130.877 1.84594 132.738 1L169.79 2.52269M168.267 24.8554L186.54 13.1815L169.79 2.52269M168.267 24.8554C170.129 24.1787 173.851 21.201 173.851 14.7042C173.851 8.20738 171.144 3.87618 169.79 2.52269"
            stroke="#111111"
            strokeWidth="2"
            strokeLinejoin="round"
          />
          <path
            d="M135.277 20.7952C135.615 20.1184 137.307 17.5074 137.307 12.1666C137.307 8.78286 136.394 1.91386 132.739 1.50781"
            stroke="#111111"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <path
            d="M182.852 15.9997C182.113 14.5974 182.028 11.7251 182.598 10.2752C182.762 9.85706 183.257 9.7816 183.645 10.0074C184.588 10.5557 186.354 11.6053 187.671 12.5194C188.16 12.8592 188.197 13.547 187.729 13.9161C186.297 15.0458 184.153 16.2845 183.244 16.2785C183.07 16.2774 182.933 16.1536 182.852 15.9997Z"
            fill="#111111"
          />
          <path
            d="M137.985 34.2668C139.203 72.8415 125.296 81.8084 118.19 81.47C110.184 84.5154 125.804 109.386 137.985 99.7422C153.821 85.9366 157.442 49.6628 157.273 33.2516C158.457 32.2365 161.029 28.6836 161.841 22.5929C162.856 14.9794 160.826 6.85843 157.78 5.33575C155.344 4.1176 154.58 6.50559 154.503 7.85186C154.088 7.28755 153.65 6.78897 153.212 6.35089C151.182 4.32064 150.336 6.5056 150.167 7.85186C149.34 6.89081 148.572 6.35089 148.137 6.35089C146.614 6.35089 144.584 6.35089 145.599 10.9189C147.223 17.8218 145.599 23.2696 144.584 25.1307H131.895C131.489 30.4093 135.786 33.4208 137.985 34.2668Z"
            fill="#FDFBEF"
          />
          <path
            d="M153.212 21.0702C154.662 15.2722 152.23 10.2505 150.167 7.85186M150.167 7.85186C149.34 6.89081 148.572 6.35089 148.137 6.35089C146.614 6.35089 144.584 6.35089 145.599 10.9189C147.223 17.8218 145.599 23.2696 144.584 25.1307H131.895C131.489 30.4093 135.786 33.4208 137.985 34.2668C139.203 72.8415 125.296 81.8084 118.19 81.47C110.184 84.5154 125.804 109.386 137.985 99.7422C153.821 85.9366 157.442 49.6628 157.273 33.2516C158.457 32.2365 161.029 28.6836 161.841 22.5929C162.856 14.9794 160.826 6.85843 157.78 5.33575C155.344 4.1176 154.58 6.50559 154.503 7.85186M150.167 7.85186C150.336 6.5056 151.182 4.32064 153.212 6.35089C153.65 6.78897 154.088 7.28755 154.503 7.85186M156.258 21.0702C157.937 14.771 156.49 10.5566 154.503 7.85186"
            stroke="#111111"
            strokeWidth="2"
          />
        </svg>
      </section>
      <footer>
        {data?.user?.wikiId ? (
          <Button
            onClick={() => {
              router.push('/garden')
            }}
          >
            내 정원가기
          </Button>
        ) : (
          <Button
            variant="kakao"
            disabled={isPending}
            onClick={() => !isPending && handleLogin()}
          >
            <svg
              width="22"
              height="20"
              viewBox="0 0 22 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              className="mr-3"
            >
              <path
                d="M11 0C4.92484 0 0 3.82543 0 8.54421C0 11.595 2.05893 14.2719 5.15604 15.7836C4.98754 16.356 4.0733 19.4663 4.03686 19.7107C4.03686 19.7107 4.015 19.8942 4.13566 19.9642C4.25638 20.0343 4.39828 19.9799 4.39828 19.9799C4.74437 19.9323 8.41149 17.3946 9.04626 16.954C9.68034 17.0424 10.3333 17.0884 11 17.0884C17.0752 17.0884 22 13.2631 22 8.54421C22 3.82543 17.0752 0 11 0Z"
                fill="#111111"
              />
            </svg>
            카카오 로그인
          </Button>
        )}
      </footer>
    </div>
  )
}

export default Page

Page.getLayout = (page: ReactNode) => (
  <BaseLayout showHeader={false}>{page}</BaseLayout>
)

export const getServerSideProps = (async (context) => {
  const isViewOnboard = context.req.cookies['namui-init'] ?? null
  if (!isViewOnboard) {
    return {
      redirect: {
        destination: '/onboard',
        permanent: true,
      },
    }
  }

  return {
    props: {},
  }
}) satisfies GetServerSideProps
